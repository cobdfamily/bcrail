#!/usr/bin/env bash
# With gratitude to the following:
# Flatcar Container Linux UEFI Setup Under Incus on Debian on GitHub: <https://gist.github.com/joshenders/1f67ceacaadc066e43e2312119e03533>

set -euo pipefail

BCRAIL_STATE_DIR="${BCRAIL_STATE_DIR:-/var/lib/bcrail}"
BCRAIL_CONFIG_DIR="${BCRAIL_CONFIG_DIR:-/etc/bcrail}"
BCRAIL_LOCOMOTIVE_ENV="${BCRAIL_LOCOMOTIVE_ENV:-${BCRAIL_CONFIG_DIR}/locomotive.env}"
BCRAIL_NETWORK_BRIDGE="${BCRAIL_NETWORK_BRIDGE:-incusbr0}"
BCRAIL_STORAGE_POOL="${BCRAIL_STORAGE_POOL:-default}"

if [[ -f "${BCRAIL_LOCOMOTIVE_ENV}" ]]; then
  set -a
  # shellcheck disable=SC1090
  source "${BCRAIL_LOCOMOTIVE_ENV}"
  set +a
fi

echo "Setting up directories for BCRail..."

mkdir -p "${BCRAIL_STATE_DIR}/contexts" "${BCRAIL_CONFIG_DIR}"

chmod 755 "${BCRAIL_STATE_DIR}"

if [[ ! -f "${BCRAIL_CONFIG_DIR}/ignition.json" ]]; then
  echo "Missing ${BCRAIL_CONFIG_DIR}/ignition.json; aborting." >&2
  exit 1
fi

echo "Changing the working directory to `/tmp`..."

cd /tmp

echo "Seting variables for convenience..."

export CHANNEL="stable"
export VERSION="current"
export IMAGE_BASENAME="flatcar_production_qemu_uefi"
export OVMF_DIR="/opt/incus/share/qemu"

echo "Downloading UEFI image + OMVF files for flatcar:${VERSION}..."

# ðŸ’¡ Flatcar does not yet officially support UEFI secure boot.

wget "https://${CHANNEL}.release.flatcar-linux.net/amd64-usr/${VERSION}/${IMAGE_BASENAME}_image.img"

echo "Creating metadata file for image and compressing..."

cat << EOF > metadata.yaml
---
architecture: x86_64
creation_date: $(date +%s)
properties:
    description: ${IMAGE_BASENAME}_image
    os: Flatcar
    release: ${VERSION}
EOF

tar -cvzf metadata.tar.gz metadata.yaml

echo "Importing metadata and image to local image repository..."

incus image import metadata.tar.gz "${IMAGE_BASENAME}_image.img" --alias "flatcar/${VERSION}"

echo "Creating an new profile for the instance..."

# ðŸ’¡ This profile is configured for 16GiB of memory, 2 CPUs, 16GiB root disk, setting the instance to autostart on boot and disabling secureboot as the EFI image of Flatcar we're using is unsigned. It uses some advanced directives for overridng the generated qemu and apparmor configuration.

# ðŸ’¡ For a full list of instance options, see here. If you're unsure what to set here, you can always change this later.

# ðŸ’¡ To align with the project goal of invisibility, the project namespace of "bcrail" is hereafter used where possible. This includes in the profile name below.

incus profile create bcrail

incus profile edit bcrail << EOF
---
config:
  limits.memory: 16GiB
  limits.cpu: 2
  boot.autostart: true
  security.secureboot: "false"
description: BCRail
devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: ${BCRAIL_NETWORK_BRIDGE}
    type: nic
  root:
    path: /
    pool: ${BCRAIL_STORAGE_POOL}
    type: disk
    size: 16GiB
name: bcrail
used_by:
EOF

echo "Initializing default context..."

bcrail setcontext default ${VERSION}
