#!/usr/bin/env bash
# With gratitude to:
# Flatcar Container Linux UEFI Setup Under Incus on Debian:
# https://gist.github.com/joshenders/1f67ceacaadc066e43e2312119e03533
set -euo pipefail

BCRAIL_STATE_DIR="${BCRAIL_STATE_DIR:-/var/lib/bcrail}"
BCRAIL_CONFIG_DIR="${BCRAIL_CONFIG_DIR:-/etc/bcrail}"
BCRAIL_LOCOMOTIVE_ENV="${BCRAIL_LOCOMOTIVE_ENV:-${BCRAIL_CONFIG_DIR}/locomotive.env}"
BCRAIL_NETWORK_BRIDGE="${BCRAIL_NETWORK_BRIDGE:-incusbr0}"
BCRAIL_STORAGE_POOL="${BCRAIL_STORAGE_POOL:-default}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -x "${SCRIPT_DIR}/../../bin/bcrail" ]]; then
  BCRAIL_CMD="${SCRIPT_DIR}/../../bin/bcrail"
else
  BCRAIL_CMD="bcrail"
fi

if [[ -f "${BCRAIL_LOCOMOTIVE_ENV}" ]]; then
  set -a
  # shellcheck disable=SC1090
  source "${BCRAIL_LOCOMOTIVE_ENV}"
  set +a
fi

require_command() {
  local cmd="$1"
  if ! command -v "${cmd}" >/dev/null 2>&1; then
    echo "Required command not found: ${cmd}" >&2
    exit 2
  fi
}

if [[ "${BCRAIL_CMD}" != "bcrail" && ! -x "${BCRAIL_CMD}" ]]; then
  echo "Required command not found: ${BCRAIL_CMD}" >&2
  exit 2
fi
if [[ "${BCRAIL_CMD}" == "bcrail" ]]; then
  require_command bcrail
fi
require_command incus
require_command tar
require_command wget

echo "Setting up directories for BCRail..."
mkdir -p "${BCRAIL_STATE_DIR}/contexts" "${BCRAIL_CONFIG_DIR}"
chmod 755 "${BCRAIL_STATE_DIR}"

if [[ ! -f "${BCRAIL_CONFIG_DIR}/ignition.json" ]]; then
  echo "Missing ${BCRAIL_CONFIG_DIR}/ignition.json; aborting." >&2
  exit 1
fi

cd /tmp

CHANNEL="${CHANNEL:-stable}"
VERSION="${VERSION:-current}"
IMAGE_BASENAME="${IMAGE_BASENAME:-flatcar_production_qemu_uefi}"
IMAGE_FILE="${IMAGE_BASENAME}_image.img"
IMAGE_URL="https://${CHANNEL}.release.flatcar-linux.net/amd64-usr/${VERSION}/${IMAGE_FILE}"
IMAGE_ALIAS="flatcar/${VERSION}"

echo "Downloading Flatcar UEFI image for ${IMAGE_ALIAS}..."
if [[ ! -f "${IMAGE_FILE}" ]]; then
  wget "${IMAGE_URL}"
else
  echo "Reusing existing image file: ${IMAGE_FILE}"
fi

echo "Creating metadata for image import..."
cat << EOF > metadata.yaml
---
architecture: x86_64
creation_date: $(date +%s)
properties:
  description: ${IMAGE_BASENAME}_image
  os: Flatcar
  release: ${VERSION}
EOF

tar -czf metadata.tar.gz metadata.yaml

echo "Importing image alias ${IMAGE_ALIAS}..."
if incus image info "local:${IMAGE_ALIAS}" >/dev/null 2>&1; then
  echo "Image alias already exists: ${IMAGE_ALIAS}"
else
  incus image import metadata.tar.gz "${IMAGE_FILE}" --alias "${IMAGE_ALIAS}"
fi

echo "Ensuring Incus profile 'bcrail' exists..."
if ! incus profile show bcrail >/dev/null 2>&1; then
  incus profile create bcrail
fi

incus profile edit bcrail << EOF
---
config:
  limits.memory: 16GiB
  limits.cpu: 2
  boot.autostart: "true"
  security.secureboot: "false"
description: BCRail
devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: ${BCRAIL_NETWORK_BRIDGE}
    type: nic
  root:
    path: /
    pool: ${BCRAIL_STORAGE_POOL}
    type: disk
    size: 16GiB
name: bcrail
EOF

echo "Initializing default context..."
"${BCRAIL_CMD}" setcontext default "${VERSION}"
