#!/usr/bin/env bash
set -euo pipefail

BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -x "${BIN_DIR}/bcrail" ]]; then
  BCRAIL_BIN="${BIN_DIR}/bcrail"
else
  BCRAIL_BIN="bcrail"
fi

BCRAIL_STATE_DIR="${BCRAIL_STATE_DIR:-/var/lib/bcrail}"
BCRAIL_CONFIG_DIR="${BCRAIL_CONFIG_DIR:-/etc/bcrail}"
BCRAIL_LOCOMOTIVE_ENV="${BCRAIL_LOCOMOTIVE_ENV:-${BCRAIL_CONFIG_DIR}/locomotive.env}"
BCRAIL_REMOTE_USER="${BCRAIL_REMOTE_USER:-vancouver}"
if [[ -f "${BCRAIL_LOCOMOTIVE_ENV}" ]]; then
  set -a
  # shellcheck disable=SC1090
  source "${BCRAIL_LOCOMOTIVE_ENV}"
  set +a
fi

if ! command -v ssh >/dev/null 2>&1; then
  echo "Required command not found: ssh" >&2
  exit 2
fi

SSH_OPTS=(
  -o BatchMode=yes
  -o ConnectTimeout=10
  -o StrictHostKeyChecking=accept-new
)

context="$("${BCRAIL_BIN}" getcontext)"
host="bcrail-${context}"
key="${BCRAIL_STATE_DIR}/contexts/${context}/keys/${host}"
dns="$("${BCRAIL_BIN}" resolve-incus-dns "${host}")"

if [[ ! -f "${key}" ]]; then
  echo "SSH key not found: ${key}" >&2
  exit 2
fi

remote_cmd=(docker "$@")
ssh "${SSH_OPTS[@]}" -i "${key}" "${BCRAIL_REMOTE_USER}@${dns}" "$(printf '%q ' "${remote_cmd[@]}")"
